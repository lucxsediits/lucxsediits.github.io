<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shibuya Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        .tab-content, #client-portal-container { display: none; }
        .tab-content.active { display: block; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1c2128; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #484f58; }
        
        input[type=range] {
            -webkit-appearance: none; appearance: none; width: 100%; cursor: pointer;
            outline: none; border-radius: 9999px; height: 6px; background: #30363d;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; height: 18px; width: 18px;
            background-color: #2f81f7; border-radius: 50%; border: 2px solid #161b22;
            transition: transform 0.2s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        
        select option {
            background: #161b22;
            color: #c9d1d9;
        }

        .card-enter {
            animation: card-enter-anim 300ms ease-out forwards;
        }
        @keyframes card-enter-anim {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .highlight {
            animation: highlight-anim 1.5s ease-out;
        }
        @keyframes highlight-anim {
            0% { background-color: rgba(47, 129, 247, 0.3); }
            100% { background-color: transparent; }
        }
        .chat-bubble {
            display: flex;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            max-width: 80%;
            font-size: 0.875rem;
            line-height: 1.25rem;
            word-wrap: break-word;
        }
        .chat-bubble.sent {
            background-color: #2f81f7;
            color: #fff;
            margin-left: auto;
        }
        .chat-bubble.received {
            background-color: #30363d;
            color: #c9d1d9;
            margin-right: auto;
        }
    </style>
</head>
<body class="bg-[#0d1117] text-[#c9d1d9]">

    <div id="notification" class="fixed top-5 right-5 bg-green-600 text-white py-2 px-5 rounded-lg shadow-2xl transform translate-x-[120%] transition-transform duration-500 ease-in-out z-50"></div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-[#161b22] border border-[#30363d] rounded-xl shadow-2xl p-8 w-full max-w-sm text-center transform transition-all scale-95 opacity-0" id="modal-content">
            <p id="modal-message" class="text-lg mb-8"></p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">Cancelar</button>
                <button id="modal-confirm-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4 bg-grid-pattern">
        <div class="w-full max-w-md">
            <h1 class="text-5xl font-bold text-blue-500 text-center mb-8">Shibuya Hub</h1>

            <div id="pre-login-section" style="display: none;" class="bg-[#161b22] border border-[#30363d] p-8 rounded-xl shadow-2xl text-center">
                <p class="mb-4">Continuar como:</p>
                <p id="pre-login-email" class="font-bold text-lg text-white mb-6"></p>
                <button id="pre-login-yes" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 mb-3">Sim, sou eu</button>
                <button id="pre-login-switch" class="w-full bg-[#30363d] hover:bg-[#484f58] font-bold py-2 px-4 rounded-lg transition-colors duration-300">Trocar de conta</button>
            </div>
            
            <div id="main-auth-wrapper">
                <div id="login-section" class="bg-[#161b22] border border-[#30363d] p-8 rounded-xl shadow-2xl">
                    <form id="login-form">
                        <h2 class="text-2xl font-semibold mb-6 text-center text-white">Entrar na sua conta</h2>
                        <div class="mb-4">
                            <input id="login-email" type="email" placeholder="Email" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <input id="login-password" type="password" placeholder="Senha" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Entrar</button>
                        <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    </form>
                    <div class="text-center mt-6">
                        <a href="#" id="show-signup" class="text-blue-400 hover:underline">Não tem uma conta? Crie uma agora!</a>
                    </div>
                </div>
                <div id="signup-section" style="display: none;" class="bg-[#161b22] border border-[#30363d] p-8 rounded-xl shadow-2xl">
                    <form id="signup-form">
                        <h2 class="text-2xl font-semibold mb-6 text-center text-white">Criar Conta</h2>
                        <div class="mb-4">
                            <input id="signup-email" type="email" placeholder="Email" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <input id="signup-password" type="password" placeholder="Senha (mínimo 6 caracteres)" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300">Criar Conta</button>
                        <p id="signup-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    </form>
                     <div class="text-center mt-6">
                        <a href="#" id="show-login" class="text-blue-400 hover:underline">Já tem uma conta? Entrar</a>
                     </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="app-container" style="display: none;" class="flex h-screen">
        <nav class="w-20 bg-[#161b22] border-r border-[#30363d] flex flex-col items-center py-6 space-y-6">
            <button id="home-btn" class="text-blue-500 hover:text-blue-400 transition-colors" title="Início">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 6H7c-2.2 0-4 1.8-4 4s1.8 4 4 4h10c2.2 0 4 1.8 4 4s-1.8 4-4 4H7"></path>
                </svg>
            </button>
            <div class="flex flex-col space-y-4">
                 <button class="sidebar-link active p-3 rounded-lg text-white bg-blue-600" data-tab="dashboard" title="Visão Geral">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                 </button>
                 <button class="sidebar-link p-3 rounded-lg hover:bg-[#30363d] transition-colors" data-tab="projects" title="Projetos">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                 </button>
                 <button class="sidebar-link p-3 rounded-lg hover:bg-[#30363d] transition-colors" data-tab="portfolios" title="Portfólios">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                 </button>
                 <button class="sidebar-link p-3 rounded-lg hover:bg-[#30363d] transition-colors" data-tab="financial" title="Financeiro">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                 </button>
                 <button class="sidebar-link p-3 rounded-lg hover:bg-[#30363d] transition-colors" data-tab="calculator" title="Calculadora">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="8" y2="14"></line><line x1="16" y1="18" x2="8" y2="18"></line><line x1="10" y1="10" x2="14" y2="10"></line></svg>
                 </button>
                 <button class="sidebar-link p-3 rounded-lg hover:bg-[#30363d] transition-colors" data-tab="community" title="Comunidade">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                 </button>
            </div>
            <div class="mt-auto flex flex-col space-y-4">
                 <button class="sidebar-link p-3 rounded-lg hover:bg-[#30363d] transition-colors" data-tab="messages" title="Mensagens">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                 </button>
                 <button class="sidebar-link p-3 rounded-lg hover:bg-[#30363d] transition-colors" data-tab="profile" title="Perfil">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                 </button>
                 <button class="sidebar-link p-3 rounded-lg hover:bg-[#30363d] transition-colors" data-tab="tutorial" title="Tutorial">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                 </button>
                 <button id="logout-btn" class="p-3 rounded-lg text-red-500 hover:bg-red-500 hover:text-white transition-colors" title="Sair">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                 </button>
            </div>
        </nav>
        
        <main class="flex-1 overflow-y-auto p-6 lg:p-10">
            <header class="flex justify-between items-center mb-8">
                 <h1 id="page-title" class="text-3xl font-bold text-white">Visão Geral</h1>
                 <div class="relative">
                     <button id="notifications-btn" class="text-gray-400 hover:text-white transition-colors relative">
                          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                          <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center" style="display: none;"></span>
                     </button>
                     <div id="notifications-panel" class="absolute right-0 mt-2 w-80 bg-[#161b22] border border-[#30363d] rounded-lg shadow-2xl p-3 z-10" style="display: none;"></div>
                 </div>
            </header>

            <div>
                <div id="dashboard" class="tab-content active">
                    <div id="project-cards-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                        </div>
                </div>
                <div id="projects" class="tab-content space-y-10">
                    <div class="bg-[#161b22] border border-[#30363d] p-8 rounded-xl max-w-3xl mx-auto shadow-lg">
                        <h2 class="text-2xl font-bold mb-6 text-white">Adicionar Novo Projeto</h2>
                        <form id="add-project-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <input type="text" id="project-name" placeholder="Nome do Projeto" class="p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <input type="text" id="client-name" placeholder="Nome do Cliente" class="p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="date" id="deadline" class="p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <input type="number" id="project-value" placeholder="Valor (R$)" class="p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="mb-6">
                                <label for="template-select" class="block text-sm font-medium mb-2">Usar Template</label>
                                <select id="template-select" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Nenhum</option>
                                </select>
                            </div>
                            <div class="border-t border-[#30363d] pt-4 mt-4">
                                <h3 class="text-lg font-semibold mb-4">Status Iniciais</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="storyboard-status" class="block text-sm mb-1">Storyboard</label>
                                        <select id="storyboard-status" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg"><option>Pendente</option><option>Em Andamento</option><option>Concluído</option></select>
                                    </div>
                                    <div>
                                        <label for="recortes-status" class="block text-sm mb-1">Recortes</label>
                                        <select id="recortes-status" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg"><option>Pendente</option><option>Em Andamento</option><option>Concluído</option></select>
                                    </div>
                                    <div>
                                        <label for="camera-status" class="block text-sm mb-1">Câmera</label>
                                        <select id="camera-status" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg"><option>Pendente</option><option>Em Andamento</option><option>Concluído</option></select>
                                    </div>
                                    <div>
                                        <label for="cc-status" class="block text-sm mb-1">CC (Color Correction)</label>
                                        <select id="cc-status" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg"><option>Pendente</option><option>Em Andamento</option><option>Concluído</option></select>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="w-full mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Adicionar Projeto</button>
                        </form>
                    </div>
                     <div class="bg-[#161b22] border border-[#30363d] p-8 rounded-xl max-w-3xl mx-auto shadow-lg mt-6">
                        <h2 class="text-2xl font-bold mb-4 text-white">Agendar Lembrete</h2>
                        <p class="text-sm text-gray-400 mb-4">Receba uma notificação no painel em uma data e hora específicas.</p>
                        <form id="add-reminder-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <input type="text" id="reminder-text" placeholder="Descrição do lembrete" class="p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <input type="datetime-local" id="reminder-datetime" class="p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <button type="submit" class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Agendar</button>
                        </form>
                    </div>

                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-white">Meus Projetos</h2>
                        <div class="flex flex-col md:flex-row gap-4 mb-6">
                            <input type="search" id="search-projects-input" placeholder="Buscar por nome ou cliente..." class="w-full md:w-1/2 p-3 bg-[#161b22] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div id="project-filters" class="flex items-center gap-2 bg-[#161b22] border border-[#30363d] p-1 rounded-lg">
                                <button data-filter="all" class="px-4 py-2 text-sm rounded-md bg-blue-600 text-white">Todos</button>
                                <button data-filter="pending" class="px-4 py-2 text-sm rounded-md hover:bg-[#30363d] transition-colors">Pendentes</button>
                                <button data-filter="overdue" class="px-4 py-2 text-sm rounded-md hover:bg-[#30363d] transition-colors">Atrasados</button>
                                <button data-filter="completed" class="px-4 py-2 text-sm rounded-md hover:bg-[#30363d] transition-colors">Concluídos</button>
                            </div>
                        </div>

                        <div id="inprogress-projects-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                            </div>

                        <div id="completed-projects-section" class="mt-12" style="display: none;">
                            <h2 class="text-2xl font-bold mb-4 text-white">Projetos Concluídos</h2>
                            <div id="completed-projects-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                                </div>
                        </div>
                    </div>
                </div>
                <div id="agenda" class="tab-content">
                     <div id="calendar-container" class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl max-w-4xl mx-auto"></div>
                </div>
                <div id="portfolios" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                             <h2 class="text-2xl font-bold mb-4 text-white">Meu Portfólio</h2>
                             <p class="text-sm mb-4">Publique seu portfólio para que outros editores e clientes possam encontrar você.</p>
                             <form id="portfolio-form" class="space-y-4">
                                 <input type="text" id="portfolio-name" placeholder="Seu nome de editor" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg" required>
                                 <input type="url" id="portfolio-link" placeholder="Link do seu Portfólio" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg" required>
                                 <input type="text" id="portfolio-specialties" placeholder="Especialidades (Ex: AMV, Edits)" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                 <input type="text" id="portfolio-price" placeholder="Informação de Preço" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                 <div class="flex gap-2 pt-2">
                                     <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                                     <button type="button" id="delete-portfolio-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Remover</button>
                                 </div>
                             </form>
                        </div>
                        <div class="lg:col-span-2">
                            <h2 class="text-2xl font-bold mb-4 text-white">Encontrar Editores</h2>
                            <input type="search" id="search-portfolio-input" placeholder="Buscar por nome ou especialidade..." class="w-full p-3 mb-4 bg-[#161b22] border border-[#30363d] rounded-lg">
                            <div id="portfolio-filters" class="flex flex-wrap gap-2 mb-6">
                                <button class="tag-filter-btn px-3 py-1 text-sm bg-[#30363d] hover:bg-[#484f58] rounded-full transition-colors" data-filter="MMV">MMV</button>
                                <button class="tag-filter-btn px-3 py-1 text-sm bg-[#30363d] hover:bg-[#484f58] rounded-full transition-colors" data-filter="AMV">AMV</button>
                                <button class="filter-btn text-sm border border-[#30363d] py-1 px-3 rounded-full hover:bg-[#30363d] transition-colors" data-filter="Lyric">Lyric</button>
                            </div>
                            <div id="portfolios-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                </div>
                        </div>
                    </div>
                </div>
                <div id="financial" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl text-center">
                            <h3 class="text-lg">Total Ganho (Concluídos)</h3>
                            <p id="total-earned" class="text-4xl font-bold text-green-400 mt-2">R$ 0.00</p>
                        </div>
                         <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl text-center">
                             <h3 class="text-lg">Potencial (Em Andamento)</h3>
                             <p id="total-potential" class="text-4xl font-bold text-yellow-400 mt-2">R$ 0.00</p>
                         </div>
                    </div>
                    <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                        <h3 class="text-xl font-bold mb-4 text-white">Ganhos Mensais</h3>
                        <canvas id="monthly-income-chart" class="mb-6"></canvas>
                        <div id="monthly-income-details" class="space-y-2"></div>
                    </div>
                </div>
                <div id="calculator" class="tab-content max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                            <h2 class="text-xl font-bold mb-4 text-white">Calculadora de Preço por Tempo</h2>
                            <div class="space-y-3">
                                <input type="number" id="calc-price-per-minute" placeholder="Preço base por minuto (R$)" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                <div class="flex gap-2">
                                    <input type="number" id="calc-minutes" placeholder="Minutos" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                    <input type="number" id="calc-seconds" placeholder="Segundos" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                </div>
                                <button id="calculate-price-btn" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-semibold">Calcular Preço</button>
                                <div id="price-result" class="mt-4 text-center pt-2"></div>
                            </div>
                        </div>
                        <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                             <h2 class="text-xl font-bold mb-4 text-white">Calculadora de Desconto por Atraso</h2>
                             <div class="space-y-3">
                                 <input type="number" id="calc-original-value" placeholder="Valor original (R$)" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                 <input type="number" id="calc-delay" placeholder="Dias de atraso" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                 <input type="number" id="calc-discount-percent" placeholder="Desconto por dia (%)" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg">
                                 <button id="calculate-discount-btn" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-semibold">Calcular Desconto</button>
                                 <div id="discount-result" class="mt-4 text-center pt-2"></div>
                             </div>
                        </div>
                    </div>
                </div>
                 <div id="messages" class="tab-content">
                    <div class="max-w-xl mx-auto bg-[#161b22] border border-[#30363d] p-6 rounded-xl h-[80vh] flex flex-col">
                        <h2 class="text-2xl font-bold mb-4 text-white">Mensagens Diretas</h2>
                        <div id="messages-container" class="flex-1 overflow-y-auto space-y-3 p-4 bg-[#0d1117] rounded-lg mb-4">
                            <p class="text-center text-gray-500">Nenhuma conversa encontrada.</p>
                        </div>
                        <form id="message-form" class="flex gap-2">
                            <input type="text" id="message-input" class="flex-1 p-3 bg-[#0d1117] border border-[#30363d] rounded-lg" placeholder="Digite sua mensagem...">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Enviar</button>
                        </form>
                    </div>
                </div>
                 <div id="profile" class="tab-content max-w-2xl mx-auto">
                     <div class="bg-[#161b22] border border-[#30363d] p-8 rounded-xl">
                          <h2 class="text-2xl font-bold mb-6 text-white">Meu Perfil</h2>
                          <form id="profile-form" class="space-y-6">
                              <div class="flex items-center gap-6">
                                  <img id="profile-pic-preview" src="https://placehold.co/100x100/161b22/c9d1d9?text=Foto" class="w-24 h-24 rounded-full object-cover bg-[#0d1117]">
                                  <div>
                                      <label for="profile-pic-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                          Trocar Foto
                                      </label>
                                      <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
                                  </div>
                              </div>
                              
                              <p>Email: <span id="user-email" class="font-semibold text-white"></span></p>

                              <div>
                                  <label for="profile-bio" class="block text-sm font-medium mb-2">Biografia</label>
                                  <textarea id="profile-bio" rows="4" placeholder="Fale um pouco sobre si, suas especialidades e como os clientes podem entrar em contato." class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                              </div>

                              <div class="border-t border-[#30363d] pt-6">
                                  <h3 class="text-xl font-bold text-white mb-4">Cores de Status do Prazo</h3>
                                  <p class="text-sm text-gray-400 mb-4">Personalize as cores dos cartões de projeto para se adequar ao seu fluxo de trabalho.</p>
                                  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                      <div>
                                          <label for="color-ok" class="block text-sm mb-1">Prazo OK</label>
                                          <input type="color" id="color-ok" value="#22c55e" class="w-full h-10 p-1 bg-[#0d1117] border border-[#30363d] rounded-lg cursor-pointer">
                                      </div>
                                      <div>
                                          <label for="color-warning" class="block text-sm mb-1">Prazo Próximo</label>
                                          <input type="color" id="color-warning" value="#facc15" class="w-full h-10 p-1 bg-[#0d1117] border border-[#30363d] rounded-lg cursor-pointer">
                                      </div>
                                      <div>
                                          <label for="color-danger" class="block text-sm mb-1">Prazo Atrasado</label>
                                          <input type="color" id="color-danger" value="#ef4444" class="w-full h-10 p-1 bg-[#0d1117] border border-[#30363d] rounded-lg cursor-pointer">
                                      </div>
                                  </div>
                              </div>

                              <div>
                                  <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Salvar Alterações</button>
                              </div>
                          </form>
                     </div>
                 </div>
                 <div id="community" class="tab-content max-w-4xl mx-auto space-y-6">
                    <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                         <h2 class="text-2xl font-bold mb-4 text-white">Comunidade</h2>
                         <p class="text-gray-400">Encontre e compartilhe recursos valiosos para aprimorar suas habilidades de edição.</p>
                         
                         <div class="mt-6 flex flex-col sm:flex-row gap-4">
                            <input type="search" id="search-community-input" placeholder="Buscar por título ou tag..." class="w-full sm:w-1/2 p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div id="community-tags-filter" class="flex flex-wrap items-center gap-2">
                                <button class="tag-filter-btn px-3 py-1 text-sm bg-[#30363d] hover:bg-[#484f58] rounded-full transition-colors" data-tag="MMV">#MMV</button>
                                <button class="tag-filter-btn px-3 py-1 text-sm bg-[#30363d] hover:bg-[#484f58] rounded-full transition-colors" data-tag="After Effects">#After Effects</button>
                                <button class="tag-filter-btn px-3 py-1 text-sm bg-[#30363d] hover:bg-[#484f58] rounded-full transition-colors" data-tag="Edits">#Edits</button>
                            </div>
                         </div>
                    </div>

                    <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                        <h3 class="text-xl font-bold mb-4">Novo Post</h3>
                        <form id="share-resource-form" class="space-y-4">
                            <input type="text" id="resource-title" placeholder="Título do Post" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg" required>
                            <input type="url" id="resource-link" placeholder="Link (YouTube, Google Drive, etc.)" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg" required>
                            <input type="text" id="resource-tags" placeholder="Tags (Ex: 'MMV', 'Transição', 'After Effects')" class="w-full p-3 bg-[#0d1117] border border-[#30363d] rounded-lg">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Fazer Post</button>
                        </form>
                    </div>

                    <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                        <h3 class="text-xl font-bold mb-4">Posts da Comunidade</h3>
                        <div id="community-resources-container" class="space-y-4">
                            </div>
                    </div>
                </div>
                 <div id="tutorial" class="tab-content">
                      <div class="max-w-4xl mx-auto space-y-8">
                          <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                              <h2 class="text-2xl font-bold text-white mb-4">Bem-vindo ao Shibuya Hub!</h2>
                              <p>Este tutorial irá guiá-lo através de todas as funcionalidades disponíveis para que você possa gerenciar seus projetos de edição com eficiência.</p>
                          </div>

                          <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                              <h3 class="text-xl font-bold text-blue-400 mb-3">Dashboard (Visão Geral)</h3>
                              <p class="mb-2">Esta é a sua tela inicial. Aqui você vê todos os seus projetos em formato de "cards".</p>
                              <ul class="list-disc list-inside space-y-2 text-gray-300">
                                  <li><strong>Cards de Projeto:</strong> Cada card mostra o nome do projeto, cliente, valor e o prazo de entrega. A cor da borda indica o status do prazo (verde para tranquilo, amarelo para próximo, vermelho para atrasado).</li>
                                  <li><strong>Status das Etapas:</strong> Você pode alterar o status de cada etapa (Storyboard, Recortes, Câmera, CC) diretamente no card.</li>
                                  <li><strong>Progresso:</strong> Arraste a barra de progresso para atualizar o quão completo está o projeto.</li>
                                  <li><strong>Ações Rápidas:</strong> Use os botões para concluir o projeto, salvá-lo como um template para uso futuro, compartilhar com o cliente ou deletar o projeto.</li>
                                  <li><strong>Ficheiros e Comentários:</strong> Anexe arquivos importantes e veja os comentários recentes diretamente no card.</li>
                              </ul>
                          </div>

                          <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                              <h3 class="text-xl font-bold text-blue-400 mb-3">Aba de Projetos</h3>
                              <p class="mb-2">É aqui que a mágica começa. Adicione novos projetos preenchendo o formulário.</p>
                               <ul class="list-disc list-inside space-y-2 text-gray-300">
                                   <li><strong>Formulário:</strong> Insira os detalhes básicos como nome, cliente, prazo e valor.</li>
                                   <li><strong>Templates:</strong> Se você já salvou um projeto como template, pode selecioná-lo no menu "Usar Template" para preencher automaticamente as informações de status e valor.</li>
                                   <li><strong>Status Iniciais:</strong> Defina o estado inicial para cada etapa do novo projeto.</li>
                               </ul>
                          </div>

                          <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                              <h3 class="text-xl font-bold text-blue-400 mb-3">Aba de Portfólios</h3>
                              <p class="mb-2">Esta área é para se conectar com a comunidade.</p>
                               <ul class="list-disc list-inside space-y-2 text-gray-300">
                                   <li><strong>Meu Portfólio:</strong> Preencha suas informações para que outros editores e potenciais clientes possam encontrar você. Adicione seu nome, link para o portfólio, especialidades e informações de preço.</li>
                                   <li><strong>Encontrar Editores:</strong> Procure por outros editores usando a barra de busca ou os filtros de especialidade. É uma ótima maneira de encontrar parceiros para projetos ou se inspirar.</li>
                               </ul>
                          </div>

                          <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                              <h3 class="text-xl font-bold text-blue-400 mb-3">Aba Financeiro</h3>
                              <p class="mb-2">Tenha uma visão clara dos seus ganhos.</p>
                               <ul class="list-disc list-inside space-y-2 text-gray-300">
                                   <li><strong>Painéis de Ganhos:</strong> Veja o total ganho com projetos já concluídos e o valor potencial dos projetos que ainda estão em andamento.</li>
                                   <li><strong>Gráfico de Ganhos Mensais:</strong> O gráfico de barras mostra seus ganhos mensais com base na data de entrega dos projetos concluídos, ajudando você a visualizar sua performance ao longo do tempo.</li>
                               </ul>
                          </div>
                            
                           <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                              <h3 class="text-xl font-bold text-blue-400 mb-3">Aba de Comunidade</h3>
                              <p class="mb-2">Uma área para a comunidade de editores. Encontre tutoriais, dicas e compartilhe seus próprios conhecimentos.</p>
                              <ul class="list-disc list-inside space-y-2 text-gray-300">
                                   <li><strong>Tutoriais Recomendados:</strong> Descubra tutoriais e recursos valiosos para aprimorar suas habilidades de edição, especialmente para MMVs e edits de rap geek.</li>
                                   <li><strong>Compartilhar Conhecimento:</strong> Use o formulário abaixo para enviar um link de um tutorial ou recurso que você achou útil. A comunidade agradece!</li>
                               </ul>
                          </div>
                            
                          <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                              <h3 class="text-xl font-bold text-blue-400 mb-3">Aba Calculadora</h3>
                              <p class="mb-2">Ferramentas úteis para o dia a dia.</p>
                               <ul class="list-disc list-inside space-y-2 text-gray-300">
                                   <li><strong>Calculadora de Preço por Tempo:</strong> Não sabe quanto cobrar por um vídeo de 2 minutos e 30 segundos? Insira seu preço por minuto e a duração do vídeo para obter o valor total instantaneamente.</li>
                                   <li><strong>Calculadora de Desconto por Atraso:</strong> Se você tem uma política de descontos por atraso na entrega, esta calculadora ajuda a determinar o valor final, aplicando uma porcentagem de desconto por cada dia de atraso.</li>
                               </ul>
                          </div>
                            
                          <div class="bg-[#161b22] border border-[#30363d] p-6 rounded-xl">
                              <h3 class="text-xl font-bold text-blue-400 mb-3">Portal do Cliente</h3>
                              <p class="mb-2">Compartilhe o progresso com seus clientes de forma profissional.</p>
                               <ul class="list-disc list-inside space-y-2 text-gray-300">
                                   <li><strong>Como compartilhar:</strong> No card do projeto, clique no ícone de compartilhamento (três pontos conectados). Isso copiará um link único para a sua área de transferência.</li>
                                   <li><strong>O que o cliente vê:</strong> Ao acessar o link, seu cliente verá uma página dedicada ao projeto dele, com o progresso geral, status de cada etapa, arquivos para download e uma caixa de comentários para feedback. Tudo isso sem precisar de login!</li>
                               </ul>
                          </div>
                      </div>
                 </div>
            </div>
            <footer class="text-center py-6 text-sm text-gray-500">
                <p>FEITO POR @LUCXSEDIITS</p>
            </footer>
        </main>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-40" style="display: none;">
        <div class="bg-[#161b22] border border-[#30363d] rounded-xl shadow-2xl p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6 text-white">Editar Projeto</h2>
            <form id="edit-project-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="edit-project-name" placeholder="Nome do Projeto" class="p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="text" id="edit-client-name" placeholder="Nome do Cliente" class="p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="date" id="edit-deadline" class="p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="number" id="edit-project-value" placeholder="Valor (R$)" class="p-3 bg-[#0d1117] border border-[#30363d] rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex gap-4 pt-4 mt-4">
                    <button type="button" id="cancel-edit-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" id="save-edit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="client-portal-container" class="min-h-screen p-4 md:p-8">
        </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, setDoc, getDoc, setLogLevel, arrayUnion, writeBatch, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // --- Your web app's Firebase configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBe14b2ITHUch8-LytK5ZrtCgfvxUFrq8s",
            authDomain: "mmvhub-56702.firebaseapp.com",
            projectId: "mmvhub-56702",
            storageBucket: "mmvhub-56702.appspot.com",
            messagingSenderId: "786807517566",
            appId: "1:786807517566:web:6e29c5e2d5d13203c9032f"
        };

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        setLogLevel('debug');

        // --- GLOBAL STATE ---
        let projects = [];
        let projectTemplates = [];
        let allPublicPortfolios = [];
        let allCommunityResources = [];
        let reminders = [];
        let messages = [];
        let activePortfolioFilters = new Set();
        let activeCommunityFilters = new Set();
        let currentUserId = null;
        let userProfile = {};
        let unsubscribeFromProjects = null;
        let unsubscribeFromTemplates = null;
        let unsubscribeFromPortfolios = null;
        let unsubscribeFromProfile = null;
        let unsubscribeFromReminders = null;
        let unsubscribeFromMessages = null;
        let noteUpdateTimeout = null;
        let monthlyIncomeChart = null;
        let timeUpdateInterval = null;
        let activeProjectFilter = 'all';
        let projectSearchTerm = '';
        let communitySearchTerm = '';
        let calendar = null;
        let isEditing = false;
        let currentEditProjectId = null;

        // --- DOM ELEMENTS ---
        const notification = document.getElementById('notification');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalContent = document.getElementById('modal-content');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const clientPortalContainer = document.getElementById('client-portal-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const logoutBtn = document.getElementById('logout-btn');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const loginErrorMsg = document.getElementById('login-error');
        const signupErrorMsg = document.getElementById('signup-error');
        const userEmailSpan = document.getElementById('user-email');
        const notificationsBtn = document.getElementById('notifications-btn');
        const notificationBadge = document.getElementById('notification-badge');
        const notificationsPanel = document.getElementById('notifications-panel');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const pageTitle = document.getElementById('page-title');
        const addProjectForm = document.getElementById('add-project-form');
        const projectCardsContainer = document.getElementById('project-cards-container');
        const templateSelect = document.getElementById('template-select');
        const portfolioForm = document.getElementById('portfolio-form');
        const deletePortfolioBtn = document.getElementById('delete-portfolio-btn');
        const portfoliosContainer = document.getElementById('portfolios-container');
        const searchPortfolioInput = document.getElementById('search-portfolio-input');
        const portfolioFilters = document.getElementById('portfolio-filters');
        const calculatePriceBtn = document.getElementById('calculate-price-btn');
        const calculateDiscountBtn = document.getElementById('calculate-discount-btn');
        const totalEarnedEl = document.getElementById('total-earned');
        const totalPotentialEl = document.getElementById('total-potential');
        const monthlyIncomeDetailsEl = document.getElementById('monthly-income-details');
        const preLoginSection = document.getElementById('pre-login-section');
        const mainAuthWrapper = document.getElementById('main-auth-wrapper');
        const preLoginEmail = document.getElementById('pre-login-email');
        const preLoginYesBtn = document.getElementById('pre-login-yes');
        const preLoginSwitchBtn = document.getElementById('pre-login-switch');
        const homeBtn = document.getElementById('home-btn');
        const searchProjectsInput = document.getElementById('search-projects-input');
        const projectFilters = document.getElementById('project-filters');
        const inprogressProjectsContainer = document.getElementById('inprogress-projects-container');
        const completedProjectsContainer = document.getElementById('completed-projects-container');
        const completedProjectsSection = document.getElementById('completed-projects-section');
        const calendarContainer = document.getElementById('calendar-container');
        const profileForm = document.getElementById('profile-form');
        const editModal = document.getElementById('edit-modal');
        const editProjectForm = document.getElementById('edit-project-form');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const shareResourceForm = document.getElementById('share-resource-form');
        const communityResourcesContainer = document.getElementById('community-resources-container');
        const searchCommunityInput = document.getElementById('search-community-input');
        const communityTagsFilter = document.getElementById('community-tags-filter');
        const addReminderForm = document.getElementById('add-reminder-form');
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');

        // --- PAGE LOAD ROUTING ---
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get('mode');
            const projectId = params.get('projectId');
            const userId = params.get('userId');

            if (mode === 'client' && projectId && userId) {
                authContainer.style.display = 'none';
                appContainer.style.display = 'none';
                clientPortalContainer.style.display = 'block';
                loadClientPortal(userId, projectId);
            } else {
                clientPortalContainer.style.display = 'none';
            }
        });

        // --- PRE-LOGIN LOGIC ---
        const lastUserEmail = localStorage.getItem('lastUserEmail');
        if (lastUserEmail) {
            preLoginEmail.textContent = lastUserEmail;
            preLoginSection.style.display = 'block';
            mainAuthWrapper.style.display = 'none';
        } else {
            mainAuthWrapper.style.display = 'block';
        }

        preLoginYesBtn.addEventListener('click', () => {
            preLoginSection.style.display = 'none';
            mainAuthWrapper.style.display = 'block';
            document.getElementById('login-email').value = lastUserEmail;
            document.getElementById('login-password').focus();
        });

        preLoginSwitchBtn.addEventListener('click', () => {
            localStorage.removeItem('lastUserEmail');
            preLoginSection.style.display = 'none';
            mainAuthWrapper.style.display = 'block';
            document.getElementById('login-form').reset();
            document.getElementById('login-email').focus();
        });

        // --- UI FUNCTIONS ---
        const showNotification = (message, isError = false) => {
            notification.textContent = message;
            notification.classList.toggle('bg-red-600', isError);
            notification.classList.toggle('bg-green-600', !isError);
            notification.classList.remove('translate-x-[120%]');
            setTimeout(() => {
                notification.classList.add('translate-x-[120%]');
            }, 3000);
        };

        let confirmCallback = null;
        const showConfirmationModal = (message, onConfirm) => {
            modalMessage.innerHTML = message;
            confirmCallback = onConfirm;
            confirmationModal.style.display = 'flex';
            setTimeout(() => {
                 modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        };

        const hideConfirmationModal = () => {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                confirmationModal.style.display = 'none';
                confirmCallback = null;
            }, 200);
        };

        modalConfirmBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            hideConfirmationModal();
        });

        modalCancelBtn.addEventListener('click', hideConfirmationModal);

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('mode') === 'client') return;

            if (user) {
                localStorage.setItem('lastUserEmail', user.email);
                currentUserId = user.uid;
                userEmailSpan.textContent = user.email;
                authContainer.style.display = 'none';
                appContainer.style.display = 'flex';

                listenToUserProfile(user);
                listenToProjects();
                listenToTemplates();
                listenToPortfolios();
                listenToResources();
                listenToReminders();
                listenToMessages();
                loadMyPortfolio();
                
                if (timeUpdateInterval) clearInterval(timeUpdateInterval);
                timeUpdateInterval = setInterval(() => {
                    renderDashboardCards();
                    renderProjectLists();
                    generateAndRenderNotifications();
                }, 60000);

            } else {
                currentUserId = null;
                authContainer.style.display = 'flex';
                appContainer.style.display = 'none';

                if (timeUpdateInterval) clearInterval(timeUpdateInterval);

                if (unsubscribeFromProjects) unsubscribeFromProjects();
                if (unsubscribeFromTemplates) unsubscribeFromTemplates();
                if (unsubscribeFromPortfolios) unsubscribeFromPortfolios();
                if (unsubscribeFromResources) unsubscribeFromResources();
                if (unsubscribeFromReminders) unsubscribeFromReminders();
                if (unsubscribeFromMessages) unsubscribeFromMessages();
                if (unsubscribeFromProfile) unsubscribeFromProfile();
                projects = [];
                projectTemplates = [];
                allCommunityResources = [];
                reminders = [];
                messages = [];
                renderDashboardCards();
                renderProjectLists();
                portfoliosContainer.innerHTML = '';
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    loginErrorMsg.textContent = "Email ou senha inválidos.";
                });
        });

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    switch (error.code) {
                        case 'auth/email-already-in-use': signupErrorMsg.textContent = "Este email já está em uso."; break;
                        case 'auth/invalid-email': signupErrorMsg.textContent = "O formato do email é inválido."; break;
                        case 'auth/weak-password': signupErrorMsg.textContent = "A senha é muito fraca (mínimo 6 caracteres)."; break;
                        default: signupErrorMsg.textContent = "Ocorreu um erro ao criar a conta."; break;
                    }
                });
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        showSignupBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('signup-section').style.display = 'block';
        });

        showLoginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('signup-section').style.display = 'none';
        });
        
        // --- PROFILE SYSTEM ---
        const listenToUserProfile = (user) => {
            if (unsubscribeFromProfile) unsubscribeFromProfile();
            const userDocRef = doc(db, 'users', user.uid);
            unsubscribeFromProfile = onSnapshot(userDocRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    const defaultProfile = {
                        email: user.email, bio: '', photoURL: '',
                        deadlineColors: { ok: '#22c55e', warning: '#facc15', danger: '#ef4444' }
                    };
                    await setDoc(userDocRef, defaultProfile);
                    userProfile = defaultProfile;
                } else {
                    userProfile = docSnap.data();
                }
                renderProfileUI();
                applyCustomColors();
            });
        };

        const renderProfileUI = () => {
            if (!userProfile) return;
            document.getElementById('profile-bio').value = userProfile.bio || '';
            document.getElementById('profile-pic-preview').src = userProfile.photoURL || 'https://placehold.co/100x100/161b22/c9d1d9?text=Foto';
            if (userProfile.deadlineColors) {
                document.getElementById('color-ok').value = userProfile.deadlineColors.ok;
                document.getElementById('color-warning').value = userProfile.deadlineColors.warning;
                document.getElementById('color-danger').value = userProfile.deadlineColors.danger;
            }
        };

        const applyCustomColors = () => {
            if (!userProfile.deadlineColors) return;
            let customStyle = document.getElementById('custom-colors-style');
            if (!customStyle) {
                customStyle = document.createElement('style');
                customStyle.id = 'custom-colors-style';
                document.head.appendChild(customStyle);
            }
            customStyle.innerHTML = `
                .border-green-500 { border-color: ${userProfile.deadlineColors.ok} !important; }
                .border-yellow-400, .border-yellow-500 { border-color: ${userProfile.deadlineColors.warning} !important; }
                .border-red-500 { border-color: ${userProfile.deadlineColors.danger} !important; }
            `;
        };

        document.getElementById('profile-pic-upload').addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('profile-pic-preview').src = event.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            showNotification("Salvando perfil...");

            const newBio = document.getElementById('profile-bio').value;
            const newColors = {
                ok: document.getElementById('color-ok').value,
                warning: document.getElementById('color-warning').value,
                danger: document.getElementById('color-danger').value,
            };
            
            const file = document.getElementById('profile-pic-upload').files[0];
            
            try {
                const updatedProfileData = {
                    bio: newBio,
                    deadlineColors: newColors,
                    photoURL: userProfile.photoURL || ''
                };

                if (file) {
                    const storageRef = ref(storage, `users/${currentUserId}/profile.jpg`);
                    await uploadBytes(storageRef, file);
                    updatedProfileData.photoURL = await getDownloadURL(storageRef);
                }

                await updateDoc(doc(db, 'users', currentUserId), updatedProfileData);
                showNotification("Perfil salvo com sucesso!");
            } catch (error) {
                console.error("Erro ao salvar perfil:", error);
                showNotification("Erro ao salvar o perfil.", true);
            }
        });


        // --- FIRESTORE & APP LOGIC ---
        const getProjectsCollectionPath = () => currentUserId ? `users/${currentUserId}/projects` : null;
        const getTemplatesCollectionPath = () => currentUserId ? `users/${currentUserId}/templates` : null;
        const getResourcesCollectionPath = () => 'resources';
        const getRemindersCollectionPath = () => currentUserId ? `users/${currentUserId}/reminders` : null;
        const getMessagesCollectionPath = () => currentUserId ? `messages` : null;


        const listenToProjects = () => {
            if (unsubscribeFromProjects) unsubscribeFromProjects();
            const path = getProjectsCollectionPath();
            if (!path) return;
            unsubscribeFromProjects = onSnapshot(collection(db, path), (snapshot) => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), order: doc.data().order || 0 }));
                renderDashboardCards();
                renderProjectLists();
                renderFinancialDashboard();
                generateAndRenderNotifications();
            }, (error) => {
                console.error("Erro ao buscar projetos: ", error);
                showNotification("Erro ao carregar projetos.", true);
            });
        };

        const listenToTemplates = () => {
            if(unsubscribeFromTemplates) unsubscribeFromTemplates();
            const path = getTemplatesCollectionPath();
            if (!path) return;
            unsubscribeFromTemplates = onSnapshot(collection(db, path), (snapshot) => {
                projectTemplates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTemplateOptions();
            });
        }
        
        const listenToReminders = () => {
            if (unsubscribeFromReminders) unsubscribeFromReminders();
            const path = getRemindersCollectionPath();
            if (!path) return;
            unsubscribeFromReminders = onSnapshot(query(collection(db, path), orderBy('timestamp')), (snapshot) => {
                reminders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateAndRenderNotifications();
            });
        };
        
        const listenToMessages = () => {
            if (unsubscribeFromMessages) unsubscribeFromMessages();
            if (!currentUserId) return;
            const path = getMessagesCollectionPath();
            if (!path) return;
            const q = query(collection(db, path), where('participants', 'array-contains', currentUserId), orderBy('timestamp'));
            unsubscribeFromMessages = onSnapshot(q, (snapshot) => {
                messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMessages();
            });
        };

        const renderMessages = () => {
            messagesContainer.innerHTML = '';
            if (messages.length === 0) {
                messagesContainer.innerHTML = `<p class="text-center text-gray-500">Nenhuma conversa encontrada.</p>`;
                return;
            }
            messages.forEach(msg => {
                const isSent = msg.senderId === currentUserId;
                const bubbleClass = isSent ? 'sent' : 'received';
                const alignmentClass = isSent ? 'ml-auto' : 'mr-auto';
                const timestamp = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleString('pt-BR') : '';
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${bubbleClass} ${alignmentClass}`;
                bubble.innerHTML = `
                    <div class="flex flex-col">
                        <p>${msg.text}</p>
                        <span class="text-[10px] opacity-70 mt-1 self-end">${timestamp}</span>
                    </div>
                `;
                messagesContainer.appendChild(bubble);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        const handleMessageSubmission = async (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            const messageData = {
                text,
                senderId: currentUserId,
                timestamp: serverTimestamp(),
                participants: ['adminId', currentUserId]
            };

            try {
                await addDoc(collection(db, getMessagesCollectionPath()), messageData);
                input.value = '';
            } catch (error) {
                console.error("Error sending message: ", error);
                showNotification("Erro ao enviar a mensagem.", true);
            }
        };


        const listenToPortfolios = () => {
            if (unsubscribeFromPortfolios) unsubscribeFromPortfolios();
            unsubscribeFromPortfolios = onSnapshot(collection(db, 'portfolios'), (snapshot) => {
                allPublicPortfolios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyFiltersAndRenderPortfolios();
            }, (error) => {
                console.error("Erro ao buscar portfólios: ", error);
                showNotification("Erro ao carregar portfólios.", true);
            });
        };

        let unsubscribeFromResources = null;
        const listenToResources = () => {
            if(unsubscribeFromResources) unsubscribeFromResources();
            unsubscribeFromResources = onSnapshot(collection(db, getResourcesCollectionPath()), (snapshot) => {
                allCommunityResources = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyCommunityFiltersAndRender();
            });
        };
        
        const loadMyPortfolio = async () => {
            if (!currentUserId) return;
            const docSnap = await getDoc(doc(db, 'portfolios', currentUserId));
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('portfolio-name').value = data.editorName || '';
                document.getElementById('portfolio-link').value = data.portfolioLink || '';
                document.getElementById('portfolio-specialties').value = data.specialties || '';
                document.getElementById('portfolio-price').value = data.priceInfo || '';
            } else {
                portfolioForm.reset();
            }
        };

        const switchTab = (tabId) => {
            tabContents.forEach(content => content.classList.remove('active'));
            sidebarLinks.forEach(button => {
                button.classList.remove('active', 'bg-blue-600', 'text-white');
                if (button.dataset.tab === tabId) {
                    button.classList.add('active', 'bg-blue-600', 'text-white');
                    pageTitle.textContent = button.title;
                }
            });
            document.getElementById(tabId).classList.add('active');
            if (tabId === 'agenda') {
                renderCalendar();
            }
        };
        
        const calculateDaysLeft = (deadline) => {
            if (!deadline) return { days: Infinity, text: 'Sem prazo', colorClass: 'border-gray-700' };

            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            const parts = deadline.split('-');
            if (parts.length !== 3) return { days: Infinity, text: 'Data inválida', colorClass: 'border-yellow-700' };
            const deadlineDate = new Date(parts[0], parseInt(parts[1]) - 1, parts[2]);
            
            if (isNaN(deadlineDate.getTime())) return { days: Infinity, text: 'Data inválida', colorClass: 'border-yellow-700' };

            const diffTime = deadlineDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                const daysAgo = Math.abs(diffDays);
                const dayText = daysAgo === 1 ? 'dia' : 'dias';
                return { days: diffDays, text: `Atrasado ${daysAgo} ${dayText}`, colorClass: 'border-red-500' };
            }
            if (diffDays === 0) return { days: diffDays, text: 'Entrega hoje!', colorClass: 'border-yellow-400' };
            if (diffDays === 1) return { days: diffDays, text: `Falta 1 dia`, colorClass: 'border-yellow-500' };
            
            return { days: diffDays, text: `Faltam ${diffDays} dias`, colorClass: 'border-green-500' };
        };


        const getStatusIcon = (status) => {
            switch(status) {
                case 'Em Andamento': return `<svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                case 'Concluído': return `<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                default: return `<svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            }
        };

        const renderStatusSelect = (id, field, label, status) => {
            const selected = (val) => val === status ? 'selected' : '';
            return `
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2">
                        ${getStatusIcon(status)}
                        <label for="${field}-${id}" class="text-gray-400">${label}</label>
                    </div>
                    <select data-id="${id}" data-field="${field}" class="status-select bg-[#0d1117] border border-[#30363d] rounded p-1 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="Pendente" ${selected('Pendente')}>Pendente</option>
                        <option value="Em Andamento" ${selected('Em Andamento')}>Em Andamento</option>
                        <option value="Concluído" ${selected('Concluído')}>Concluído</option>
                    </select>
                </div>
            `;
        };
        
        const renderCards = (container, projectList, sortable = false) => {
            container.innerHTML = '';
            if (projectList.length === 0) {
                container.innerHTML = `<p class="text-center md:col-span-2 xl:col-span-3 2xl:col-span-4 text-gray-500">Nenhum projeto encontrado.</p>`;
                return;
            }
        
            const sortedProjects = [...projectList].sort((a, b) => {
                if (a.order !== undefined && b.order !== undefined) {
                    return a.order - b.order;
                }
                const aDays = calculateDaysLeft(a.deadline).days;
                const bDays = calculateDaysLeft(b.deadline).days;
                return aDays - bDays;
            });
        
            sortedProjects.forEach(project => {
                const deadlineInfo = calculateDaysLeft(project.deadline);
                const isCompleted = project.progress == 100;
        
                let finalBorderClass = deadlineInfo.colorClass;
                let finalText = deadlineInfo.text;
                if (isCompleted) {
                    finalBorderClass = 'border-blue-500';
                    finalText = 'Concluído';
                }
        
                const filesHTML = (project.files || []).map(file => `
                    <li class="text-xs truncate">
                        <a href="${file.url}" target="_blank" class="text-blue-400 hover:underline flex items-center gap-1.5">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                            ${file.name}
                        </a>
                    </li>`).join('') || '<li class="text-xs text-gray-500">Nenhum ficheiro.</li>';
                
                const commentsHTML = (project.comments || []).map(comment => `
                    <div class="text-xs p-2 rounded-md ${comment.author === 'Editor' ? 'bg-blue-900/40 text-right' : 'bg-gray-700/40'}" style="word-wrap: break-word;">
                        <p>${comment.text}</p>
                        <p class="text-gray-400 text-[10px] mt-1 text-right">${new Date(comment.timestamp.toDate()).toLocaleString('pt-BR')}</p>
                    </div>
                `).join('') || '<li class="text-xs text-gray-500">Nenhum comentário.</li>';

                const card = document.createElement('div');
                card.id = `project-card-${project.id}`;
                card.draggable = sortable;
                card.dataset.id = project.id;
                card.dataset.order = project.order;
                card.classList.add('bg-[#161b22]', 'border', 'border-[#30363d]', 'p-5', 'rounded-xl', 'shadow-lg', 'flex', 'flex-col', 'justify-between', 'transition-transform', 'duration-200', 'hover:-translate-y-1', 'border-l-4', finalBorderClass, 'cursor-grab', 'active:cursor-grabbing');
                
                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-white">${project.name}</h3>
                            <div class="flex items-center gap-2">
                                <button class="edit-project-btn text-gray-500 hover:text-blue-400 transition-colors" data-id="${project.id}" title="Editar Projeto">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                 </button>
                                 <button class="share-project-btn text-gray-500 hover:text-blue-400 transition-colors" data-id="${project.id}" title="Partilhar com Cliente">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                                 </button>
                                 <button class="delete-project-btn text-gray-500 hover:text-red-500 transition-colors font-bold text-lg" data-id="${project.id}">&times;</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-400 mb-1">Cliente: ${project.client || 'N/A'}</p>
                        <p class="text-sm text-gray-400 mb-2">Valor: <span class="font-semibold text-green-400">R$ ${parseFloat(project.value || 0).toFixed(2)}</span></p>
                        <p class="text-sm font-semibold mb-4 px-2 py-1 inline-block rounded-md bg-opacity-20">${finalText}</p>
                        
                        <div class="border-t border-[#30363d] pt-3 mt-3 space-y-2.5">
                            ${renderStatusSelect(project.id, 'storyboardStatus', 'Storyboard', project.storyboardStatus || 'Pendente')}
                            ${renderStatusSelect(project.id, 'recortesStatus', 'Recortes', project.recortesStatus || 'Pendente')}
                            ${renderStatusSelect(project.id, 'cameraStatus', 'Câmera', project.cameraStatus || 'Pendente')}
                            ${renderStatusSelect(project.id, 'ccStatus', 'CC', project.ccStatus || 'Pendente')}
                        </div>
                        
                        <div class="border-t border-[#30363d] pt-3 mt-4">
                           <label class="text-sm">Comentários</label>
                           <div class="mt-1 space-y-1.5 max-h-24 overflow-y-auto pr-1">${commentsHTML}</div>
                        </div>

                        <div class="border-t border-[#30363d] pt-3 mt-4">
                            <label class="text-sm">Ficheiros</label>
                            <ul class="mt-1 space-y-1.5">${filesHTML}</ul>
                            <label class="block w-full text-center mt-2 px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-md cursor-pointer transition-colors">
                                Anexar Ficheiro
                                <input type="file" class="hidden file-upload-input" data-id="${project.id}">
                            </label>
                        </div>
                    </div>
                    <div class="mt-6">
                        <label for="progress-${project.id}" class="text-sm font-medium">Progresso: <span id="progress-value-${project.id}" class="font-bold text-white">${project.progress || 0}%</span></label>
                        <input type="range" id="progress-${project.id}" min="0" max="100" value="${project.progress || 0}" data-id="${project.id}" class="w-full mt-2 progress-slider">
                        <div class="flex gap-2 mt-4">
                            <button class="complete-project-btn w-full py-2 text-sm bg-green-600 hover:bg-green-700 font-semibold rounded-lg transition-colors ${isCompleted ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${project.id}" ${isCompleted ? 'disabled' : ''}>Concluir</button>
                            <button class="save-template-btn w-full py-2 text-sm bg-indigo-600 hover:bg-indigo-700 font-semibold rounded-lg transition-colors" data-id="${project.id}">Salvar Template</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            if (sortable) {
                makeSortable(container);
            }
        };

        const renderDashboardCards = () => {
            const inProgressProjects = projects.filter(p => p.progress < 100);
            renderCards(projectCardsContainer, inProgressProjects, true);
        };

        const renderProjectLists = () => {
            let displayProjects = [...projects];

            if (projectSearchTerm) {
                displayProjects = displayProjects.filter(p => 
                    (p.name || '').toLowerCase().includes(projectSearchTerm) ||
                    (p.client || '').toLowerCase().includes(projectSearchTerm)
                );
            }

            let filteredInProgress = displayProjects.filter(p => p.progress < 100);
            let completed = displayProjects.filter(p => p.progress == 100);

            if (activeProjectFilter === 'pending') {
                filteredInProgress = filteredInProgress.filter(p => calculateDaysLeft(p.deadline).days >= 0);
                completed = [];
            } else if (activeProjectFilter === 'overdue') {
                filteredInProgress = filteredInProgress.filter(p => calculateDaysLeft(p.deadline).days < 0);
                completed = [];
            } else if (activeProjectFilter === 'completed') {
                filteredInProgress = [];
            }
            
            renderCards(inprogressProjectsContainer, filteredInProgress);
            renderCards(completedProjectsContainer, completed);
            
            completedProjectsSection.style.display = completed.length > 0 ? 'block' : 'none';
        };

        const makeSortable = (container) => {
            let dragSrcEl = null;

            function handleDragStart(e) {
                this.style.opacity = '0.4';
                dragSrcEl = this;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                return false;
            }

            function handleDragEnter(e) {
                this.classList.add('bg-[#30363d]');
            }

            function handleDragLeave(e) {
                this.classList.remove('bg-[#30363d]');
            }

            async function handleDrop(e) {
                e.stopPropagation();
                if (dragSrcEl !== this) {
                    const fromId = dragSrcEl.dataset.id;
                    const toId = this.dataset.id;
                    const fromOrder = parseInt(dragSrcEl.dataset.order);
                    const toOrder = parseInt(this.dataset.order);

                    const reorderedProjects = projects.filter(p => p.progress < 100).sort((a,b) => a.order - b.order);
                    
                    const fromIndex = reorderedProjects.findIndex(p => p.id === fromId);
                    const [draggedItem] = reorderedProjects.splice(fromIndex, 1);
                    const toIndex = reorderedProjects.findIndex(p => p.id === toId);
                    reorderedProjects.splice(toIndex, 0, draggedItem);

                    const batch = writeBatch(db);
                    const path = getProjectsCollectionPath();
                    reorderedProjects.forEach((project, index) => {
                        const projectRef = doc(db, path, project.id);
                        batch.update(projectRef, { order: index });
                    });
                    await batch.commit();
                }
                return false;
            }

            function handleDragEnd(e) {
                this.style.opacity = '1';
                container.querySelectorAll('div').forEach((item) => {
                    item.classList.remove('bg-[#30363d]');
                });
            }

            container.querySelectorAll('div').forEach((item) => {
                item.addEventListener('dragstart', handleDragStart, false);
                item.addEventListener('dragenter', handleDragEnter, false);
                item.addEventListener('dragover', handleDragOver, false);
                item.addEventListener('dragleave', handleDragLeave, false);
                item.addEventListener('drop', handleDrop, false);
                item.addEventListener('dragend', handleDragEnd, false);
            });
        };

        const renderCalendar = () => {
            if (!calendarContainer) return;
            const markedDates = projects.map(p => {
                if (p.deadline) {
                    return {
                        date: p.deadline,
                        description: p.name,
                    }
                }
                return null;
            }).filter(Boolean);

            const options = {
                isDark: true,
                markedDates,
                 popups: projects.reduce((acc, p) => {
                     if (p.deadline) {
                         if (!acc[p.deadline]) {
                             acc[p.deadline] = [];
                         }
                         acc[p.deadline].push({
                             modifier: 'bg-blue-600',
                             html: p.name,
                         });
                     }
                     return acc;
                 }, {}),

            };
            if (!calendar) {
                calendar = new VanillaCalendar(calendarContainer, options);
                calendar.init();
            } else {
                calendar.options.markedDates = markedDates;
                calendar.options.popups = options.popups;
                calendar.update();
            }
        };


        const renderFinancialDashboard = () => {
            const completedProjects = projects.filter(p => p.progress == 100);
            const potentialProjects = projects.filter(p => p.progress < 100);

            const totalEarned = completedProjects.reduce((sum, p) => sum + parseFloat(p.value || 0), 0);
            const totalPotential = potentialProjects.reduce((sum, p) => sum + parseFloat(p.value || 0), 0);

            totalEarnedEl.textContent = `R$ ${totalEarned.toFixed(2)}`;
            totalPotentialEl.textContent = `R$ ${totalPotential.toFixed(2)}`;
            
            const monthly = {};
            completedProjects.forEach(p => {
                if(p.deadline) {
                    const month = p.deadline.substring(0, 7); // "YYYY-MM"
                    if(!monthly[month]) monthly[month] = 0;
                    monthly[month] += parseFloat(p.value || 0);
                }
            });

            const sortedMonths = Object.keys(monthly).sort();
             if(sortedMonths.length === 0) {
                 monthlyIncomeDetailsEl.innerHTML = `<p class="text-center">Nenhum projeto concluído ainda.</p>`;
                 if (monthlyIncomeChart) monthlyIncomeChart.destroy();
                 return;
             }

            const chartLabels = sortedMonths.map(month => {
                const date = new Date(month + '-02');
                return date.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
            });
            const chartData = sortedMonths.map(month => monthly[month]);

            const ctx = document.getElementById('monthly-income-chart').getContext('2d');
            if (monthlyIncomeChart) monthlyIncomeChart.destroy();
            monthlyIncomeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Ganhos Mensais',
                        data: chartData,
                        backgroundColor: 'rgba(47, 129, 247, 0.5)',
                        borderColor: 'rgba(47, 129, 247, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#8b949e' }, grid: { color: '#30363d' } },
                        x: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            monthlyIncomeDetailsEl.innerHTML = sortedMonths.reverse().map(month => {
                const date = new Date(month + '-02');
                const monthName = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                return `<div class="flex justify-between items-center bg-[#0d1117] p-3 rounded-lg">
                             <span class="capitalize">${monthName}</span>
                             <span class="font-bold text-green-400">R$ ${monthly[month].toFixed(2)}</span>
                         </div>`
            }).join('');
        };

        const renderTemplateOptions = () => {
            templateSelect.innerHTML = '<option value="">Nenhum</option>';
            projectTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.name;
                templateSelect.appendChild(option);
            });
        };

        const applyCommunityFiltersAndRender = () => {
            const searchTerm = searchCommunityInput.value.toLowerCase().trim();
            let filteredResources = [...allCommunityResources];

            if (activeCommunityFilters.size > 0) {
                filteredResources = filteredResources.filter(r => {
                    const tags = (r.tags || '').toLowerCase();
                    for (const filter of activeCommunityFilters) {
                        if (tags.includes(filter)) return true;
                    }
                    return false;
                });
            }

            if (searchTerm) {
                filteredResources = filteredResources.filter(r =>
                    (r.title || '').toLowerCase().includes(searchTerm) ||
                    (r.tags || '').toLowerCase().includes(searchTerm)
                );
            }
            
            renderResources(filteredResources);
        };
        
        const renderResources = (resources) => {
            communityResourcesContainer.innerHTML = '';
            if (resources.length === 0) {
                 communityResourcesContainer.innerHTML = `<p class="text-center text-gray-500">Nenhum post ainda. Seja o primeiro a postar!</p>`;
                 return;
            }
            const sortedResources = resources.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

            sortedResources.forEach(resource => {
                const tagsHTML = (resource.tags || '').split(',').map(tag => `<span class="text-sm text-gray-500">#${tag.trim()}</span>`).join(' ');
                const card = document.createElement('div');
                card.className = 'bg-[#0d1117] p-4 rounded-lg border border-[#30363d]';
                card.innerHTML = `
                    <a href="${resource.link}" target="_blank" class="text-blue-400 hover:underline font-bold text-lg">${resource.title}</a>
                    <p class="text-sm text-gray-400 mt-1">${tagsHTML}</p>
                `;
                communityResourcesContainer.appendChild(card);
            });
        };

        const applyFiltersAndRenderPortfolios = () => {
            const searchTerm = searchPortfolioInput.value.toLowerCase().trim();
            let filteredPortfolios = [...allPublicPortfolios];

            if (activePortfolioFilters.size > 0) {
                filteredPortfolios = filteredPortfolios.filter(p => {
                    const specialties = (p.specialties || '').toLowerCase();
                    for (const filter of activePortfolioFilters) {
                        if (specialties.includes(filter)) return true;
                    }
                    return false;
                });
            }

            if (searchTerm) {
                filteredPortfolios = filteredPortfolios.filter(p =>
                    (p.editorName || '').toLowerCase().includes(searchTerm) ||
                    (p.specialties || '').toLowerCase().includes(searchTerm)
                );
            }

            renderPublicPortfolios(filteredPortfolios);
        };

        const renderPublicPortfolios = (portfolios) => {
            portfoliosContainer.innerHTML = '';
            if (portfolios.length === 0) {
                portfoliosContainer.innerHTML = `<p class="text-center md:col-span-2">Nenhum portfólio encontrado.</p>`;
                return;
            }
            portfolios.forEach(portfolio => {
                const card = document.createElement('div');
                card.className = 'bg-[#161b22] border border-[#30363d] p-5 rounded-xl shadow-lg transition-transform hover:-translate-y-1';
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-blue-400">${portfolio.editorName}</h3>
                    <p class="text-sm mt-2 mb-3">Especialidades: ${portfolio.specialties}</p>
                    <p class="text-sm mb-4 font-semibold">Preços: ${portfolio.priceInfo}</p>
                    <a href="${portfolio.portfolioLink}" target="_blank" rel="noopener noreferrer" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Ver Portfólio</a>
                `;
                portfoliosContainer.appendChild(card);
            });
        };
        
        const handleAddOrEditProject = async (e) => {
            e.preventDefault();
            const path = getProjectsCollectionPath();
            if (!path) {
                showNotification("Erro: Utilizador não autenticado.", true);
                return;
            }

            const isAddForm = e.target.id === 'add-project-form';

            const projectName = isAddForm ? document.getElementById('project-name').value : document.getElementById('edit-project-name').value;
            const projectValue = parseFloat(isAddForm ? document.getElementById('project-value').value : document.getElementById('edit-project-value').value) || 0;
            const clientName = isAddForm ? document.getElementById('client-name').value : document.getElementById('edit-client-name').value;
            const deadline = isAddForm ? document.getElementById('deadline').value : document.getElementById('edit-deadline').value;
            
            const newProjectData = {
                name: projectName,
                client: clientName,
                deadline: deadline,
                value: projectValue,
            };

            if (isAddForm) {
                if (projectValue <= 1) {
                    showConfirmationModal(
                        `Tem certeza que deseja adicionar o projeto "${projectName}" com o valor de R$ ${projectValue.toFixed(2)}?`,
                        async () => {
                            try {
                                const fullNewProject = {
                                    ...newProjectData,
                                    progress: 0,
                                    storyboardStatus: document.getElementById('storyboard-status').value,
                                    recortesStatus: document.getElementById('recortes-status').value,
                                    cameraStatus: document.getElementById('camera-status').value,
                                    ccStatus: document.getElementById('cc-status').value,
                                    notes: "",
                                    files: [],
                                    comments: [],
                                    public: false,
                                    order: projects.length
                                };
                                await addDoc(collection(db, path), fullNewProject);
                                addProjectForm.reset();
                                templateSelect.value = "";
                                switchTab('dashboard');
                                showNotification("Projeto adicionado com sucesso!");
                            } catch (error) {
                                console.error("Error adding document: ", error);
                                showNotification("Erro ao adicionar projeto.", true);
                            }
                        }
                    );
                } else {
                     try {
                         const fullNewProject = {
                             ...newProjectData,
                             progress: 0,
                             storyboardStatus: document.getElementById('storyboard-status').value,
                             recortesStatus: document.getElementById('recortes-status').value,
                             cameraStatus: document.getElementById('camera-status').value,
                             ccStatus: document.getElementById('cc-status').value,
                             notes: "",
                             files: [],
                             comments: [],
                             public: false,
                             order: projects.length
                         };
                         await addDoc(collection(db, path), fullNewProject);
                         addProjectForm.reset();
                         templateSelect.value = "";
                         switchTab('dashboard');
                         showNotification("Projeto adicionado com sucesso!");
                     } catch (error) {
                         console.error("Error adding document: ", error);
                         showNotification("Erro ao adicionar projeto.", true);
                     }
                }
            } else {
                try {
                    await updateDoc(doc(db, path, currentEditProjectId), newProjectData);
                    editModal.style.display = 'none';
                    showNotification("Projeto atualizado com sucesso!");
                    isEditing = false;
                    currentEditProjectId = null;
                } catch (error) {
                    console.error("Error updating document: ", error);
                    showNotification("Erro ao atualizar projeto.", true);
                }
            }
        };

        addProjectForm.addEventListener('submit', handleAddOrEditProject);
        editProjectForm.addEventListener('submit', handleAddOrEditProject);
        addReminderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('reminder-text').value;
            const datetime = document.getElementById('reminder-datetime').value;
            if (!text || !datetime || !currentUserId) {
                showNotification("Preencha todos os campos do lembrete.", true);
                return;
            }
            try {
                await addDoc(collection(db, getRemindersCollectionPath()), {
                    text,
                    timestamp: new Date(datetime),
                    createdAt: serverTimestamp(),
                    isDismissed: false
                });
                addReminderForm.reset();
                showNotification("Lembrete agendado com sucesso!");
            } catch (error) {
                console.error("Erro ao agendar lembrete:", error);
                showNotification("Erro ao agendar lembrete.", true);
            }
        });

        const openEditModal = (project) => {
            isEditing = true;
            currentEditProjectId = project.id;
            document.getElementById('edit-project-name').value = project.name;
            document.getElementById('edit-client-name').value = project.client;
            document.getElementById('edit-deadline').value = project.deadline;
            document.getElementById('edit-project-value').value = project.value;
            editModal.style.display = 'flex';
        };

        cancelEditBtn.addEventListener('click', () => {
            editModal.style.display = 'none';
            isEditing = false;
            currentEditProjectId = null;
            editProjectForm.reset();
        });

        const handleSavePortfolio = async (e) => {
            e.preventDefault();
            if (!currentUserId) return showNotification("Você precisa estar logado.", true);

            const portfolioData = {
                userId: currentUserId,
                editorName: document.getElementById('portfolio-name').value,
                portfolioLink: document.getElementById('portfolio-link').value,
                specialties: document.getElementById('portfolio-specialties').value,
                priceInfo: document.getElementById('portfolio-price').value,
                updatedAt: new Date(),
            };

            try {
                await setDoc(doc(db, "portfolios", currentUserId), portfolioData);
                showNotification("Portfólio salvo com sucesso!");
            } catch (error) {
                console.error("Error saving portfolio: ", error);
                showNotification("Erro ao salvar o portfólio.", true);
            }
        };

        const handleDeletePortfolio = async () => {
            if (!currentUserId) return;
            showConfirmationModal("Tem certeza que deseja remover seu portfólio público?", async () => {
                try {
                    await deleteDoc(doc(db, "portfolios", currentUserId));
                    showNotification("Portfólio removido com sucesso!");
                    portfolioForm.reset();
                } catch (error) {
                    console.error("Error deleting portfolio: ", error);
                    showNotification("Erro ao remover o portfólio.", true);
                }
            });
        };
        
        const handleProjectInteraction = async (e) => {
            const target = e.target;
            const button = target.closest('button');
            const projectId = target.dataset.id || button?.dataset.id || target.closest('[data-id]')?.dataset.id;

            if (!projectId) return;

            const path = getProjectsCollectionPath();
            if (!path) return;

            const projectDocRef = doc(db, path, projectId);
            const project = projects.find(p => p.id === projectId);

            if (button && button.classList.contains('edit-project-btn')) {
                if (project) {
                    openEditModal(project);
                }
                return;
            }

             if (button && button.classList.contains('share-project-btn')) {
                 try {
                     await updateDoc(projectDocRef, { public: true });
                     const url = `${window.location.origin}${window.location.pathname}?mode=client&userId=${currentUserId}&projectId=${projectId}`;
                     
                     const dummy = document.createElement('textarea');
                     document.body.appendChild(dummy);
                     dummy.value = url;
                     dummy.select();
                     document.execCommand('copy');
                     document.body.removeChild(dummy);

                     showNotification("Link do portal do cliente copiado!");
                 } catch (error) {
                     console.error("Error sharing project:", error);
                     showNotification("Erro ao partilhar o projeto.", true);
                 }
             }


            if (target.classList.contains('progress-slider')) {
                const newProgress = target.value;
                document.getElementById(`progress-value-${projectId}`).textContent = `${newProgress}%`;
                try {
                    await updateDoc(projectDocRef, { progress: Number(newProgress) });
                } catch (error) { console.error("Error updating progress: ", error); }
            }
            
            if (button && button.classList.contains('complete-project-btn')) {
                showConfirmationModal("Marcar este projeto como concluído?", async () => {
                    try {
                        await updateDoc(projectDocRef, {
                            progress: 100, storyboardStatus: 'Concluído', recortesStatus: 'Concluído',
                            cameraStatus: 'Concluído', ccStatus: 'Concluído'
                        });
                        showNotification("Projeto concluído!");
                    } catch (error) { showNotification("Erro ao concluir o projeto.", true); }
                });
            }

             if (button && button.classList.contains('save-template-btn')) {
                 const projectToSave = projects.find(p => p.id === projectId);
                 if (projectToSave) {
                     const templateName = prompt("Qual o nome para este template?", projectToSave.name);
                     if (templateName) {
                         const templateData = { ...projectToSave };
                         delete templateData.id; delete templateData.deadline; delete templateData.client;
                         delete templateData.notes; delete templateData.files; delete templateData.comments;
                         templateData.name = templateName;
                         try {
                             await addDoc(collection(db, getTemplatesCollectionPath()), templateData);
                             showNotification("Template salvo com sucesso!");
                         } catch(err) {
                             showNotification("Erro ao salvar o template.", true);
                         }
                     }
                 }
             }

            if (button && button.classList.contains('delete-project-btn')) {
                showConfirmationModal("Tem certeza que deseja remover este projeto?", async () => {
                    try {
                        await deleteDoc(projectDocRef);
                        showNotification("Projeto removido.");
                    } catch (error) { showNotification("Erro ao remover projeto.", true); }
                });
            }
            
            if (target.classList.contains('status-select')) {
                const field = target.dataset.field;
                const newValue = target.value;
                try {
                    await updateDoc(projectDocRef, { [field]: newValue });
                } catch (error) { console.error(`Error updating ${field}: `, error); }
            }

            if (target.classList.contains('notes-textarea')) {
                clearTimeout(noteUpdateTimeout);
                noteUpdateTimeout = setTimeout(async () => {
                    try {
                        await updateDoc(projectDocRef, { notes: target.value });
                    } catch (error) { console.error(`Error updating notes: `, error); }
                }, 500);
            }

            if (target.classList.contains('file-upload-input')) {
                const file = target.files[0];
                if (!file) return;

                const storageRef = ref(storage, `users/${currentUserId}/projects/${projectId}/${file.name}`);
                target.disabled = true;
                showNotification("A enviar ficheiro...");

                try {
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    await updateDoc(projectDocRef, {
                        files: arrayUnion({ name: file.name, url: downloadURL })
                    });
                    showNotification("Ficheiro enviado com sucesso!");
                } catch (error) {
                    showNotification("Erro ao enviar ficheiro.", true);
                } finally {
                    target.disabled = false;
                }
            }
        };

        const handlePortfolioFilterClick = (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const filter = e.target.dataset.filter.toLowerCase();
            e.target.classList.toggle('active');
            e.target.classList.toggle('bg-blue-600');
            e.target.classList.toggle('text-white');
            activePortfolioFilters.has(filter) ? activePortfolioFilters.delete(filter) : activePortfolioFilters.add(filter);
            applyFiltersAndRenderPortfolios();
        };
        
        const handleCommunityTagClick = (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const tag = e.target.dataset.tag.toLowerCase();
            e.target.classList.toggle('bg-blue-600');
            e.target.classList.toggle('text-white');
            activeCommunityFilters.has(tag) ? activeCommunityFilters.delete(tag) : activeCommunityFilters.add(tag);
            applyCommunityFiltersAndRender();
        };

        const handleCalculatePrice = () => {
            const pricePerMinute = parseFloat(document.getElementById('calc-price-per-minute').value) || 0;
            const minutes = parseInt(document.getElementById('calc-minutes').value) || 0;
            const seconds = parseInt(document.getElementById('calc-seconds').value) || 0;
            const resultDiv = document.getElementById('price-result');
            if (pricePerMinute <= 0 || (minutes <= 0 && seconds <= 0)) {
                resultDiv.innerHTML = `<p class="text-yellow-400">Preencha o preço e o tempo.</p>`;
                return;
            }
            const finalPrice = (pricePerMinute / 60) * ((minutes * 60) + seconds);
            resultDiv.innerHTML = `<p class="text-lg">Preço total: <span class="font-bold text-2xl text-green-400">R$ ${finalPrice.toFixed(2)}</span></p>`;
        };

        const handleCalculateDiscount = () => {
            const originalValue = parseFloat(document.getElementById('calc-original-value').value) || 0;
            const delayDays = parseInt(document.getElementById('calc-delay').value) || 0;
            const discountPercent = parseFloat(document.getElementById('calc-discount-percent').value) || 0;
            const resultDiv = document.getElementById('discount-result');
            if(originalValue <= 0 || delayDays <= 0 || discountPercent <= 0) {
                resultDiv.innerHTML = `<p class="text-yellow-400">Preencha todos os campos.</p>`;
                return;
            }
            const totalDiscountPercent = delayDays * discountPercent;
            const discountValue = originalValue * (totalDiscountPercent / 100);
            const finalValue = originalValue - discountValue;
            resultDiv.innerHTML = `<p>Desconto: <span class="font-bold">${totalDiscountPercent.toFixed(2)}% (R$ ${discountValue.toFixed(2)})</span></p><p class="text-lg mt-2">Valor final: <span class="font-bold text-2xl text-green-400">R$ ${finalValue.toFixed(2)}</span></p>`;
        };

        const handleResourceSubmission = async (e) => {
            e.preventDefault();
            if (!currentUserId) {
                showNotification("Você precisa estar logado para enviar posts.", true);
                return;
            }
            const title = document.getElementById('resource-title').value;
            const link = document.getElementById('resource-link').value;
            const tags = document.getElementById('resource-tags').value;

            if (!title || !link) {
                showNotification("Título e link são obrigatórios.", true);
                return;
            }

            const resourceData = {
                title: title,
                link: link,
                tags: tags,
                submittedBy: currentUserId,
                timestamp: new Date()
            };

            try {
                await addDoc(collection(db, getResourcesCollectionPath()), resourceData);
                shareResourceForm.reset();
                showNotification("Post enviado para a comunidade!");
            } catch (error) {
                console.error("Error submitting resource: ", error);
                showNotification("Erro ao enviar post.", true);
            }
        };
        
        const generateAndRenderNotifications = () => {
            const notifications = [];
            
            // Notifications from project deadlines
            projects.forEach(p => {
                const deadlineInfo = calculateDaysLeft(p.deadline);
                if (deadlineInfo.days <= 3 && deadlineInfo.days >= 0 && p.progress < 100) {
                    notifications.push({ message: `Prazo para "${p.name}" a terminar!`, date: p.deadline });
                } else if (deadlineInfo.days < 0 && p.progress < 100) {
                    notifications.push({ message: `Projeto "${p.name}" está atrasado!`, date: p.deadline, isUrgent: true });
                }
            });

            // Notifications from reminders
            const now = new Date();
            reminders.forEach(r => {
                const reminderDate = new Date(r.timestamp.seconds * 1000);
                if (reminderDate.getTime() <= now.getTime() && !r.isDismissed) {
                     notifications.push({ message: `Lembrete: ${r.text}`, date: reminderDate.toISOString().split('T')[0], isReminder: true, id: r.id });
                }
            });

            notificationBadge.style.display = notifications.length > 0 ? 'flex' : 'none';
            notificationBadge.textContent = notifications.length;

            notificationsPanel.innerHTML = notifications.length > 0
                ? notifications.map(n => `
                    <div class="p-2 border-b border-[#30363d] text-sm ${n.isUrgent ? 'text-red-400' : ''} flex justify-between items-center">
                        <div>
                            <p>${n.message}</p>
                            <p class="text-[10px] text-gray-500">${new Date(n.date).toLocaleString('pt-BR')}</p>
                        </div>
                        ${n.isReminder ? `<button class="dismiss-reminder-btn text-gray-500 hover:text-white" data-id="${n.id}">&times;</button>` : ''}
                    </div>
                `).join('')
                : '<div class="p-2 text-sm text-center text-gray-500">Nenhuma notificação.</div>';
        };

        const handleDismissReminder = async (reminderId) => {
            const path = getRemindersCollectionPath();
            if (!path || !reminderId) return;
            try {
                await updateDoc(doc(db, path, reminderId), { isDismissed: true });
                showNotification("Lembrete descartado.");
            } catch (error) {
                console.error("Erro ao descartar lembrete: ", error);
                showNotification("Erro ao descartar lembrete.", true);
            }
        };

        // --- CLIENT PORTAL LOGIC ---
        const loadClientPortal = (userId, projectId) => {
            const projectDocRef = doc(db, `users/${userId}/projects`, projectId);

            onSnapshot(projectDocRef, async (docSnap) => {
                if (!docSnap.exists() || docSnap.data().public === false) {
                    clientPortalContainer.innerHTML = `
                        <div class="max-w-4xl mx-auto text-center mt-12">
                            <h1 class="text-4xl font-bold text-red-500">Acesso Negado</h1>
                            <p class="text-gray-400 mt-4">Este projeto não foi encontrado ou o acesso não foi permitido pelo editor.</p>
                        </div>
                    `;
                    return;
                }
                const project = docSnap.data();

                const filesHTML = (project.files || []).map(file => `
                    <a href="${file.url}" target="_blank" class="text-blue-400 hover:underline flex items-center gap-2 bg-[#161b22] p-3 rounded-lg">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                        ${file.name}
                    </a>`).join('') || '<p class="text-gray-400">Nenhum ficheiro disponível.</p>';
                
                const commentsHTML = (project.comments || []).map(comment => `
                             <div class="p-3 rounded-lg ${comment.author === 'Editor' ? 'bg-blue-900/40 ml-auto' : 'bg-gray-700/40 mr-auto'}" style="max-width: 80%;">
                                 <p class="text-sm">${comment.text}</p>
                                 <p class="text-gray-400 text-[11px] mt-1 text-right">${new Date(comment.timestamp.toDate()).toLocaleString('pt-BR')}</p>
                             </div>
                `).join('');

                let approvalSectionHTML = '';
                const stages = ['storyboard', 'recortes', 'camera', 'cc'];
                let currentStage = '';
                
                for(const stage of stages) {
                    const status = project[`${stage}Status`];
                    if (status === 'Em Andamento') {
                        currentStage = stage;
                        break;
                    }
                }
                
                if (currentStage) {
                    approvalSectionHTML = `
                        <div class="bg-[#0d1117] p-4 rounded-xl border border-[#30363d] mt-6">
                            <p class="text-lg font-semibold mb-3">Revisar Etapa: <span class="capitalize text-blue-400">${currentStage}</span></p>
                            <form id="client-approval-form" data-stage="${currentStage}">
                                <textarea id="client-feedback-input" class="w-full p-2 bg-[#161b22] border border-[#30363d] rounded-lg resize-none mb-3" placeholder="Deixe um comentário opcional..." rows="2"></textarea>
                                <div class="flex gap-2">
                                    <button type="button" id="approve-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg">Aprovar</button>
                                    <button type="button" id="reject-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">Rejeitar</button>
                                </div>
                            </form>
                        </div>
                    `;
                }


                clientPortalContainer.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <header class="text-center mb-10">
                            <h1 class="text-4xl font-bold text-blue-500">Shibuya Hub</h1>
                            <p class="text-gray-400 mt-2">Portal de Acompanhamento do Cliente</p>
                            ${project.clientPortalGreeting ? `<p class="text-lg mt-4 font-semibold">${project.clientPortalGreeting}</p>` : ''}
                        </header>
                        <div class="bg-[#161b22] border border-[#30363d] rounded-xl p-6 md:p-8">
                            <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">${project.name}</h2>
                            <p class="text-gray-400 mb-6">Cliente: ${project.client || 'N/A'}</p>

                            <div class="mb-6">
                                <label class="text-sm font-medium">Progresso Geral</label>
                                <div class="w-full bg-[#30363d] rounded-full h-4 mt-2">
                                    <div class="bg-blue-600 h-4 rounded-full" style="width: ${project.progress || 0}%"></div>
                                </div>
                                <p class="text-right font-bold text-lg mt-1">${project.progress || 0}%</p>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                                <div class="flex items-center gap-3 p-3 bg-[#0d1117] rounded-lg">${getStatusIcon(project.storyboardStatus)} Storyboard: <span class="font-semibold ml-auto">${project.storyboardStatus}</span></div>
                                <div class="flex items-center gap-3 p-3 bg-[#0d1117] rounded-lg">${getStatusIcon(project.recortesStatus)} Recortes: <span class="font-semibold ml-auto">${project.recortesStatus}</span></div>
                                <div class="flex items-center gap-3 p-3 bg-[#0d1117] rounded-lg">${getStatusIcon(project.cameraStatus)} Câmera: <span class="font-semibold ml-auto">${project.cameraStatus}</span></div>
                                <div class="flex items-center gap-3 p-3 bg-[#0d1117] rounded-lg">${getStatusIcon(project.ccStatus)} Color Correction: <span class="font-semibold ml-auto">${project.ccStatus}</span></div>
                            </div>
                            
                            ${approvalSectionHTML}

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h3 class="text-xl font-bold mb-4 text-white">Ficheiros para Download</h3>
                                    <div class="space-y-3">${filesHTML}</div>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold mb-4 text-white">Feedback e Comentários</h3>
                                    <div id="comments-box" class="space-y-3 p-3 bg-[#0d1117] rounded-lg h-48 overflow-y-auto mb-4">${commentsHTML}</div>
                                    <form id="comment-form">
                                        <textarea id="comment-input" class="w-full p-2 bg-[#0d1117] border border-[#30363d] rounded-lg resize-none" placeholder="Deixe um comentário..." required></textarea>
                                        <button type="submit" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg">Enviar</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                         <footer class="text-center py-6 mt-4 text-sm text-gray-500">
                             <p>FEITO POR @LUCXSEDIITS</p>
                         </footer>
                    </div>
                `;
                
                const commentsBox = document.getElementById('comments-box');
                if (commentsBox) commentsBox.scrollTop = commentsBox.scrollHeight;

                document.getElementById('comment-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const input = document.getElementById('comment-input');
                    const text = input.value.trim();
                    if (text) {
                        const newComment = {
                            text,
                            author: 'Cliente',
                            timestamp: new Date()
                        };
                        try {
                            await updateDoc(projectDocRef, { comments: arrayUnion(newComment) });
                            input.value = '';
                        } catch (err) {
                            console.error("Error adding comment: ", err);
                            alert("Não foi possível enviar o seu comentário.");
                        }
                    }
                });
                
                document.getElementById('approve-btn')?.addEventListener('click', async () => {
                    const stage = document.getElementById('client-approval-form').dataset.stage;
                    const feedback = document.getElementById('client-feedback-input').value;
                    const updateData = { [`${stage}Status`]: 'Concluído' };
                    if (feedback) {
                         const newComment = { text: feedback, author: 'Cliente', timestamp: new Date() };
                         updateData.comments = arrayUnion(newComment);
                    }
                    try {
                        await updateDoc(projectDocRef, updateData);
                        showNotification("Etapa aprovada com sucesso!");
                    } catch (err) {
                        console.error("Erro ao aprovar etapa: ", err);
                        showNotification("Erro ao aprovar etapa.", true);
                    }
                });

                document.getElementById('reject-btn')?.addEventListener('click', async () => {
                     const stage = document.getElementById('client-approval-form').dataset.stage;
                     const feedback = document.getElementById('client-feedback-input').value;
                     if (!feedback) {
                          showNotification("Por favor, adicione um feedback para rejeitar a etapa.", true);
                          return;
                     }
                     const updateData = { [`${stage}Status`]: 'Pendente' };
                     const newComment = { text: feedback, author: 'Cliente', timestamp: new Date() };
                     updateData.comments = arrayUnion(newComment);
                     try {
                         await updateDoc(projectDocRef, updateData);
                         showNotification("Etapa rejeitada. Feedback enviado.");
                     } catch (err) {
                         console.error("Erro ao rejeitar etapa: ", err);
                         showNotification("Erro ao rejeitar etapa.", true);
                     }
                });
            });
        };
        
        // --- EVENT LISTENERS ---
        sidebarLinks.forEach(button => {
            button.addEventListener('click', () => switchTab(button.dataset.tab));
        });
        homeBtn.addEventListener('click', () => switchTab('dashboard'));
        
        document.body.addEventListener('input', (e) => {
            if (e.target.closest('#project-cards-container') || e.target.closest('#inprogress-projects-container') || e.target.closest('#completed-projects-container')) {
                handleProjectInteraction(e);
            }
        });
         document.body.addEventListener('change', (e) => {
            if (e.target.closest('#project-cards-container') || e.target.closest('#inprogress-projects-container') || e.target.closest('#completed-projects-container')) {
                handleProjectInteraction(e);
            }
        });
         document.body.addEventListener('click', (e) => {
            if (e.target.closest('#project-cards-container') || e.target.closest('#inprogress-projects-container') || e.target.closest('#completed-projects-container')) {
                const target = e.target;
                const button = target.closest('button');
                const projectId = target.dataset.id || button?.dataset.id || target.closest('[data-id]')?.dataset.id;
                const project = projects.find(p => p.id === projectId);
                if (button && button.classList.contains('edit-project-btn')) {
                    if (project) {
                        openEditModal(project);
                    }
                } else {
                    handleProjectInteraction(e);
                }
            }
            
            if (e.target.closest('#community-tags-filter')) {
                handleCommunityTagClick(e);
            }
            
            if (e.target.classList.contains('dismiss-reminder-btn')) {
                handleDismissReminder(e.target.dataset.id);
            }
        });

        calculatePriceBtn.addEventListener('click', handleCalculatePrice);
        calculateDiscountBtn.addEventListener('click', handleCalculateDiscount);
        shareResourceForm.addEventListener('submit', handleResourceSubmission);
        portfolioForm.addEventListener('submit', handleSavePortfolio);
        deletePortfolioBtn.addEventListener('click', handleDeletePortfolio);
        searchPortfolioInput.addEventListener('input', applyFiltersAndRenderPortfolios);
        portfolioFilters.addEventListener('click', handlePortfolioFilterClick);
        searchCommunityInput.addEventListener('input', applyCommunityFiltersAndRender);
        messageForm.addEventListener('submit', handleMessageSubmission);

        searchProjectsInput.addEventListener('input', (e) => {
            projectSearchTerm = e.target.value.toLowerCase();
            renderProjectLists();
        });

        projectFilters.addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON') {
                activeProjectFilter = e.target.dataset.filter;
                projectFilters.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('hover:bg-[#30363d]');
                });
                e.target.classList.add('bg-blue-600', 'text-white');
                e.target.classList.remove('hover:bg-[#30363d]');
                renderProjectLists();
            }
        });

        notificationsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationsPanel.style.display = notificationsPanel.style.display === 'block' ? 'none' : 'block';
        });
        templateSelect.addEventListener('change', (e) => {
            const templateId = e.target.value;
            if (templateId) {
                const template = projectTemplates.find(t => t.id === templateId);
                if (template) {
                    document.getElementById('project-name').value = template.name;
                    document.getElementById('project-value').value = template.value;
                    document.getElementById('storyboard-status').value = template.storyboardStatus;
                    document.getElementById('recortes-status').value = template.recortesStatus;
                    document.getElementById('camera-status').value = template.cameraStatus;
                    document.getElementById('cc-status').value = template.ccStatus;
                }
            } else {
                addProjectForm.reset();
            }
        });
        
        document.addEventListener('click', (e) => {
            if (!notificationsBtn.contains(e.target) && !notificationsPanel.contains(e.target)) {
                 notificationsPanel.style.display = 'none';
            }
        });

        switchTab('dashboard');

    </script>
</body>
</html>
